<!DOCTYPE html>
<html>
<head>
    <title>Typing Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
    .typing-text {
	    font-size: 18px;
	    font-family: monospace;
	    white-space: pre-wrap;
	    margin-bottom: 20px;
	}
	.typing-text span {
    	display: inline-block;
	}
    .correct{
    	color: green;
    }
    .incorrect {
    	color: red;
    }
    .current {
    	text-decoration: underline;
    }
    </style>
</head>
<body class="bg-light">

<div class="container mt-5">
    <h3 class="text-center mb-4">Typing Test (60 seconds)</h3>

    <p id="text-to-type" class="typing-text"></p>

    <textarea id="typing-area"
              class="form-control"
              rows="4"
              placeholder="Start typing here..."></textarea>

    <div class="row mt-3 text-center">
        <div class="col">
            <h5>Time Left</h5>
            <span id="timer">60</span>s
        </div>
        <div class="col">
            <h5>WPM</h5>
            <span id="wpm">0</span>
        </div>
        <div class="col">
            <h5>Accuracy</h5>
            <span id="accuracy">0</span>%
        </div>
    </div>
</div>
<script>
const text = "The quick brown fox jumps over the lazy dog.";
const textContainer = document.getElementById("text-to-type");
const typingArea = document.getElementById("typing-area");
const timerElement = document.getElementById("timer");
const wpmElement = document.getElementById("wpm");
const accuracyElement = document.getElementById("accuracy");

let timeLeft = 60;
let timerStarted = false;

/* Render text as spans */
text.split("").forEach(char => {
    const span = document.createElement("span");
    span.textContent = char;
    textContainer.appendChild(span);
});

/* Typing logic */
typingArea.addEventListener("input", () => {

    /* Start timer once */
    if (!timerStarted) {
        timerStarted = true;
        const interval = setInterval(() => {
            timeLeft--;
            timerElement.textContent = timeLeft;

            if (timeLeft <= 0) {
                clearInterval(interval);
                typingArea.disabled = true;
                
                fetch("/submitResult", {
					method: "POST",
					headers: {
						"Content-Type": "application/x-www-form-urlencoded"
					},
					body: `wpm=${wpmElement.textContent}&accuracy=${accuracyElement.textContent}`
                });
            }
        }, 1000);
    }

    const typedText = typingArea.value;

    /* Prevent overflow typing */
    if (typedText.length > text.length) {
        typingArea.value = typedText.substring(0, text.length);
        return;
    }

    const spans = textContainer.querySelectorAll("span");
    let correctChars = 0;

    spans.forEach((span, index) => {
        const typedChar = typedText[index];

        span.classList.remove("correct", "incorrect", "current");

        if (typedChar == null) {
            if (index === typedText.length) {
                span.classList.add("current");
            }
        } else if (typedChar === span.textContent) {
            span.classList.add("correct");
            correctChars++;
        } else {
            span.classList.add("incorrect");
        }
    });

    /* Accuracy */
    const accuracy = Math.round(
        (correctChars / typedText.length) * 100
    ) || 0;

    accuracyElement.textContent = accuracy;

    /* WPM */
    const words = typedText.trim().split(/\s+/).filter(w => w.length > 0);
    const timeSpent = 60 - timeLeft;

    if (timeSpent > 0) {
        const wpm = Math.round((words.length / timeSpent) * 60);
        wpmElement.textContent = wpm;
    }
});
</script>

</body>
</html>
